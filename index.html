
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quanto Falta? - Controle de Liquidez</title>

<link rel="stylesheet" href="scripts/3.4.17.css">

    <script src="scripts/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .nav-btn.active { color: #059669 !important; }
        .nav-btn.active i { transform: scale(1.1); color: #059669 !important; }
        .modal-overlay { display: none; }
        .modal-overlay.active { display: flex; }
        input, select, button { outline: none !important; }
        button *, span * { pointer-events: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .first-access-screen { display: none; position: fixed; inset: 0; z-index: 200; background: #f8fafc; align-items: center; justify-content: center; padding: 1.5rem; }
        .first-access-screen.active { display: flex; }
    </style>
<script type="importmap">
{
  "imports": {
    "date-fns": "https://esm.sh/date-fns@^4.1.0",
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body class="min-h-screen pb-24 md:pb-0 md:pl-64">

    <!-- Tela de Primeiro Acesso -->
    <div id="first-access" class="first-access-screen">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl border w-full max-w-md text-center">
            <div class="bg-emerald-50 w-20 h-20 rounded-3xl flex items-center justify-center text-emerald-600 mx-auto mb-6">
                <i data-lucide="landmark" class="w-10 h-10"></i>
            </div>
            <h2 class="text-3xl font-black text-slate-800 mb-2">Boas-vindas!</h2>
            <p class="text-slate-500 text-sm mb-8">Para começar a organizar sua vida financeira, cadastre seu primeiro banco ou conta.</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label class="text-[9px] font-black text-slate-400 uppercase ml-2">Nome do Banco / Conta</label>
                    <input type="text" id="setup-bank-name" placeholder="Ex: Nubank, Carteira, Itaú..." class="w-full p-4 bg-slate-50 border rounded-2xl font-bold">
                </div>
                <div>
                    <label class="text-[9px] font-black text-slate-400 uppercase ml-2">Saldo Atual (R$)</label>
                    <input type="number" id="setup-bank-balance" step="0.01" placeholder="0,00" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold">
                </div>
                <button onclick="window.confirmSetup()" class="w-full py-5 bg-emerald-600 text-white rounded-2xl font-black uppercase text-xs shadow-xl shadow-emerald-100 mt-4 transition-transform active:scale-95">
                    Começar a usar o App
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar Desktop -->
    <aside class="hidden md:flex flex-col w-64 bg-white border-r h-screen fixed left-0 top-0 z-40">
        <div class="p-8">
            <h1 class="text-xl font-black text-emerald-600 flex items-center gap-2">
                <i data-lucide="wallet"></i> Quanto falta?
            </h1>
        </div>
        <nav class="flex-1 px-4 space-y-2">
            <button onclick="window.switchTab('dashboard')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-2xl font-bold transition-all text-slate-400 active" data-tab="dashboard">
                <i data-lucide="layout-dashboard"></i> Dashboard
            </button>
            <button onclick="window.switchTab('transactions')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-2xl font-bold transition-all text-slate-400" data-tab="transactions">
                <i data-lucide="receipt"></i> Contas a Pagar
            </button>
            <button onclick="window.switchTab('goals')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-2xl font-bold transition-all text-slate-400" data-tab="goals">
                <i data-lucide="target"></i> Metas
            </button>
            <button onclick="window.switchTab('settings')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-2xl font-bold transition-all text-slate-400" data-tab="settings">
                <i data-lucide="settings"></i> Bancos e ajustes
            </button>
        </nav>
    </aside>

    <!-- Mobile Bottom Nav -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-3 z-50 shadow-[0_-10px_30px_rgba(0,0,0,0.05)]">
        <button onclick="window.switchTab('dashboard')" class="nav-btn flex flex-col items-center text-slate-300 active" data-tab="dashboard"><i data-lucide="layout-dashboard"></i></button>
        <button onclick="window.switchTab('transactions')" class="nav-btn flex flex-col items-center text-slate-300" data-tab="transactions"><i data-lucide="receipt"></i></button>
        <button onclick="window.switchTab('goals')" class="nav-btn flex flex-col items-center text-slate-300" data-tab="goals"><i data-lucide="target"></i></button>
        <button onclick="window.switchTab('settings')" class="nav-btn flex flex-col items-center text-slate-300" data-tab="settings"><i data-lucide="settings"></i></button>
    </nav>

    <!-- Main Content -->
    <main class="p-4 md:p-10 max-w-5xl mx-auto">
        <div id="tab-dashboard" class="tab-content active"></div>
        <div id="tab-transactions" class="tab-content"></div>
        <div id="tab-goals" class="tab-content"></div>
        <div id="tab-settings" class="tab-content"></div>
    </main>

    <!-- Overlay de Modal -->
    <div id="modal-overlay" class="modal-overlay fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-[2.5rem] p-8 w-full max-w-md shadow-2xl overflow-y-auto max-h-[90vh]"></div>
    </div>

    <script>
        // --- ESTADO ---
        let state = {
            banks: [], 
            transactions: [],
            goals: [],
            savingsPool: 0,
            categories: ['Alimentação', 'Transporte', 'Lazer', 'Moradia', 'Saúde', 'Internet', 'Serviços', 'Cartão de Crédito', 'Outros'],
            activeTab: 'dashboard'
        };

        let filters = { onlyOpen: true, sortOrder: 'asc' };

        const fmtBRL = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
        const getISO = (d) => d.toISOString().split('T')[0];
        const generateUID = () => 'u' + Date.now() + Math.random().toString(36).substr(2, 5);
        const getTotalAllocated = () => state.goals.reduce((a, g) => a + (g.current || g.currentAmount || 0), 0);

        window.save = () => { 
            localStorage.setItem('quanto_falta_v18_db', JSON.stringify(state)); 
            window.render(); 
        };

        window.load = () => {
            const data = localStorage.getItem('quanto_falta_v18_db');
            if (data) state = JSON.parse(data);
            if (!state.categories || state.categories.length === 0) {
                state.categories = ['Alimentação', 'Transporte', 'Lazer', 'Moradia', 'Saúde', 'Internet', 'Serviços', 'Cartão de Crédito', 'Outros'];
            }
        };

        window.confirmSetup = () => {
            const name = document.getElementById('setup-bank-name').value.trim();
            const balance = parseFloat(document.getElementById('setup-bank-balance').value) || 0;
            
            if (!name) {
                alert('Por favor, dê um nome à sua conta bancária.');
                return;
            }

            state.banks.push({ id: 'b'+Date.now(), name, balance });
            window.save();
            document.getElementById('first-access').classList.remove('active');
            window.render();
        };

        window.switchTab = (tabId) => {
            state.activeTab = tabId;
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const target = document.getElementById('tab-' + tabId);
            if (target) target.classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('active');
                if (b.dataset.tab === tabId) b.classList.add('active');
            });
            window.render();
        };

        // --- CATEGORIAS ---
        window.editCat = (index) => {
            const oldName = state.categories[index];
            if (!oldName) return;
            const newName = prompt('Renomear categoria:', oldName);
            if (newName && newName.trim() !== "" && newName.trim() !== oldName) {
                const cleanedName = newName.trim();
                state.categories[index] = cleanedName;
                state.transactions.forEach(t => { if (t.category === oldName) t.category = cleanedName; });
                window.save();
            }
        };

        window.delCat = (index) => {
            const catName = state.categories[index];
            if (!catName) return;
            if (confirm(`Excluir categoria "${catName}"?`)) {
                state.categories.splice(index, 1);
                window.save();
            }
        };

        window.addCat = () => { 
            const i = document.getElementById('new-cat-input'); 
            if (i && i.value.trim()){ 
                const val = i.value.trim();
                if (!state.categories.includes(val)) {
                    state.categories.push(val); 
                    i.value = ''; 
                    window.save(); 
                } else {
                    alert('Esta categoria já existe.');
                }
            } 
        };

        // --- RENDER ---
        window.render = () => {
            // Verificar Primeiro Acesso
            if (state.banks.length === 0) {
                document.getElementById('first-access').classList.add('active');
                if (window.lucide) lucide.createIcons();
                return;
            }

            const tab = state.activeTab;
            if (tab === 'dashboard') renderDashboard();
            if (tab === 'transactions') renderTransactions();
            if (tab === 'goals') renderGoals();
            if (tab === 'settings') renderSettings();
            if (window.lucide) lucide.createIcons();
        };

        function renderDashboard() {
            const totalBanks = state.banks.reduce((a, b) => a + b.balance, 0);
            const unpaidExpenses = state.transactions.filter(tx => tx.status !== 'paid').reduce((a, b) => a + b.amount, 0);
            
            const diff = totalBanks - unpaidExpenses;
            const needsMoney = diff < 0;

            const now = new Date();
            const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const daysRemaining = Math.max(1, lastDayOfMonth.getDate() - now.getDate() + 1);
            const dailyMissing = Math.abs(diff) / daysRemaining;

            document.getElementById('tab-dashboard').innerHTML = `
                <div class="space-y-8">
                    <header class="flex justify-between items-center">
                        <h2 class="text-3xl font-black text-slate-800">Dashboard</h2>
                        <button onclick="window.openTxModal()" class="bg-rose-500 text-white p-4 rounded-[1.5rem] shadow-xl"><i data-lucide="plus"></i></button>
                    </header>
                    
                    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${state.banks.map(b => `
                            <div class="bg-white p-6 rounded-[2rem] border border-slate-100 flex justify-between items-center">
                                <div class="flex items-center gap-4">
                                    <div class="bg-slate-50 p-3 rounded-2xl text-slate-400"><i data-lucide="landmark"></i></div>
                                    <p class="font-bold text-slate-700">${b.name}</p>
                                </div>
                                <p class="font-black text-emerald-600">${fmtBRL(b.balance)}</p>
                            </div>`).join('')}
                    </section>

                    <div class="${needsMoney ? 'bg-slate-900' : 'bg-emerald-600'} text-white p-8 rounded-[2.5rem] shadow-2xl relative overflow-hidden">
                        <div class="relative z-10">
                            <h3 class="text-xs font-black text-emerald-400 uppercase tracking-widest mb-4">
                                ${needsMoney ? 'Falta para Quitar Tudo' : 'Saldo Livre no Mês'}
                            </h3>
                            <span class="text-4xl font-black">${fmtBRL(Math.abs(diff))}</span>
                            <p class="text-[10px] text-white/50 mt-4 uppercase font-bold tracking-tighter">
                                Comparativo entre saldo nos bancos vs despesas em aberto
                            </p>
                        </div>
                        <i data-lucide="${needsMoney ? 'alert-triangle' : 'shield-check'}" class="absolute -right-4 -bottom-4 w-32 h-32 text-white/5 opacity-20"></i>
                    </div>

                    ${needsMoney ? `
                    <section class="bg-white p-6 rounded-[2rem] border-2 border-rose-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div class="bg-rose-50 p-4 rounded-2xl text-rose-500">
                                <i data-lucide="trending-down"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-slate-400 uppercase">Necessário por dia para quitar</p>
                                <h4 class="text-xl font-black text-slate-800">${fmtBRL(dailyMissing)} <span class="text-sm font-normal text-slate-400">/dia</span></h4>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black text-slate-400 uppercase">Fim do Mês</p>
                            <p class="font-bold text-slate-700">${daysRemaining} dias restantes</p>
                        </div>
                    </section>
                    ` : `
                    <section class="bg-emerald-50 p-6 rounded-[2rem] border border-emerald-100 flex items-center gap-4">
                        <div class="bg-emerald-100 p-4 rounded-2xl text-emerald-600"><i data-lucide="check-circle"></i></div>
                        <div>
                            <p class="text-[10px] font-black text-emerald-600 uppercase">Parabéns!</p>
                            <h4 class="text-lg font-bold text-emerald-800 tracking-tight">Você tem saldo suficiente para todas as contas deste mês.</h4>
                        </div>
                    </section>
                    `}
                </div>`;
        }

        function renderTransactions() {
            let filtered = state.transactions;
            if (filters.onlyOpen) filtered = filtered.filter(tx => tx.status !== 'paid');
            
            filtered.sort((a, b) => {
                const cmp = a.date.localeCompare(b.date);
                return filters.sortOrder === 'asc' ? cmp : -cmp;
            });

            document.getElementById('tab-transactions').innerHTML = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-3xl font-black text-slate-800">Contas</h2>
                        <div class="flex gap-2">
                            <button onclick="filters.sortOrder = (filters.sortOrder === 'asc' ? 'desc' : 'asc'); window.render();" class="px-4 py-2 rounded-xl text-[10px] font-black border uppercase bg-white text-slate-600 flex items-center gap-2">
                                <i data-lucide="${filters.sortOrder === 'asc' ? 'arrow-up-narrow-wide' : 'arrow-down-wide-narrow'}" class="w-3 h-3"></i>
                                ${filters.sortOrder === 'asc' ? 'Crescente' : 'Decrescente'}
                            </button>
                            <button onclick="filters.onlyOpen = !filters.onlyOpen; window.render();" class="px-4 py-2 rounded-xl text-[10px] font-black border uppercase ${filters.onlyOpen ? 'bg-rose-500 text-white' : 'bg-white text-slate-400'}">Apenas Abertas</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-[2rem] border overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b text-[10px] font-black text-slate-400 uppercase">
                                <tr><th class="px-6 py-4">Despesa</th><th class="px-6 py-4 text-right">Valor</th><th class="px-6 py-4"></th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                ${filtered.map(tx => `
                                <tr class="${tx.status === 'paid' ? 'opacity-50' : ''}">
                                    <td class="px-6 py-4">
                                        <p class="font-bold text-slate-700">${tx.name}</p>
                                        <p class="text-[9px] text-slate-400 uppercase font-black">${tx.category} • ${tx.date.split('-').reverse().slice(0,2).join('/')}</p>
                                    </td>
                                    <td class="px-6 py-4 text-right font-black text-slate-800">${fmtBRL(tx.amount)}</td>
                                    <td class="px-6 py-4 text-right flex justify-end gap-2">
                                        ${tx.status !== 'paid' ? `<button onclick="window.openPayModal('${tx.id}')" class="text-emerald-500 p-2"><i data-lucide="check"></i></button>` : '<span class="text-[8px] font-black text-emerald-600 uppercase bg-emerald-50 px-2 py-1 rounded">Pago</span>'}
                                        <button onclick="window.delTx('${tx.id}')" class="text-slate-200 hover:text-rose-500 p-2"><i data-lucide="trash-2"></i></button>
                                    </td>
                                </tr>`).join('')}
                                ${filtered.length === 0 ? '<tr><td colspan="3" class="p-10 text-center text-slate-400 italic">Nenhuma despesa para mostrar.</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        }

        function renderGoals() {
            const allocated = getTotalAllocated();
            const free = Math.max(0, state.savingsPool - allocated);

            document.getElementById('tab-goals').innerHTML = `
                <div class="space-y-8">
                    <header class="flex justify-between items-center">
                        <h2 class="text-3xl font-black text-slate-800">Metas</h2>
                        <button onclick="window.openGoalModal()" class="bg-blue-600 text-white p-4 rounded-[1.5rem] shadow-xl"><i data-lucide="plus"></i></button>
                    </header>
                    <div class="bg-white p-8 rounded-[2.5rem] border-2 border-slate-100 flex flex-col gap-6">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <div class="bg-emerald-50 p-4 rounded-full text-emerald-600"><i data-lucide="piggy-bank"></i></div>
                                <div><p class="text-[10px] font-black text-slate-400 uppercase">Reserva Física Total</p><h3 class="text-2xl font-black">${fmtBRL(state.savingsPool)}</h3></div>
                            </div>
                            <button onclick="window.openSupplyPoolModal()" class="px-6 py-3 bg-emerald-600 text-white rounded-xl text-[10px] font-black uppercase">Ajustar Saldo</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                                <p class="text-[9px] font-black text-blue-400 uppercase">Livre p/ Alocar</p><p class="text-lg font-black text-blue-700">${fmtBRL(free)}</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="text-[9px] font-black text-slate-400 uppercase">Comprometido</p><p class="text-lg font-black text-slate-700">${fmtBRL(allocated)}</p>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${state.goals.map(g => {
                            const current = g.current || g.currentAmount || 0;
                            const target = g.target || g.targetAmount || 1;
                            const prog = Math.min(100, (current / target) * 100);
                            return `
                            <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm relative overflow-hidden">
                                <div class="absolute top-0 left-0 h-1 bg-emerald-500" style="width: ${prog}%"></div>
                                <div class="flex justify-between mb-6">
                                    <h3 class="font-black text-slate-800 text-lg">${g.name}</h3>
                                    <div class="flex gap-1">
                                        <button onclick="window.openEditGoalModal('${g.id}')" class="text-slate-200 hover:text-blue-500 p-1"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                        <button onclick="window.openDeleteGoalModal('${g.id}')" class="text-slate-200 hover:text-rose-500 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-end mb-4">
                                    <div><p class="text-[9px] uppercase font-black text-slate-400">Progresso</p><p class="text-xl font-black text-emerald-600">${fmtBRL(current)}</p></div>
                                    <div class="text-right"><p class="text-[9px] uppercase font-black text-slate-400">Meta</p><p class="font-bold text-slate-700">${fmtBRL(target)}</p></div>
                                </div>
                                <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden mb-4"><div class="bg-emerald-500 h-full transition-all duration-700" style="width:${prog}%"></div></div>
                                <button onclick="window.openDistributeModal('${g.id}')" class="w-full py-4 bg-slate-900 text-white rounded-2xl text-[10px] font-black uppercase">Alocar do Porquinho</button>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
        }

        function renderSettings() {
            document.getElementById('tab-settings').innerHTML = `
                <div class="space-y-10">
                    <h2 class="text-3xl font-black text-slate-800">Bancos e ajustes</h2>
                    <section class="bg-white p-8 rounded-[2.5rem] border space-y-6">
                        <div class="flex justify-between items-center"><h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Meus Bancos</h3><button onclick="window.addBank()" class="text-emerald-600 font-black text-[10px] uppercase">Adicionar</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${state.banks.map(b => `
                                <div class="p-4 bg-slate-50 rounded-2xl border">
                                    <input type="text" value="${b.name}" onchange="window.updBank('${b.id}', 'name', this.value)" class="w-full bg-transparent font-black text-slate-700 border-none p-1 mb-1">
                                    <div class="flex items-center gap-2">
                                        <input type="number" step="0.01" value="${b.balance}" onchange="window.updBank('${b.id}', 'balance', this.value)" class="flex-1 bg-white rounded-lg p-2 font-black text-emerald-600 text-sm border border-slate-100">
                                        <button onclick="window.delBank('${b.id}')" class="text-slate-300 hover:text-rose-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>`).join('')}
                        </div>
                    </section>

                    <section class="bg-white p-8 rounded-[2.5rem] border space-y-6">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Categorias</h3>
                        <p class="text-[10px] text-slate-400 -mt-4 italic">Clique no texto para editar ou no ícone para gerenciar.</p>
                        <div class="flex gap-2">
                            <input type="text" id="new-cat-input" placeholder="Nova Categoria" class="flex-1 p-3 bg-slate-50 border rounded-xl font-bold">
                            <button onclick="window.addCat()" class="bg-emerald-600 text-white px-6 rounded-xl font-black uppercase text-[10px]">Add</button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${state.categories.map((c, idx) => `
                                <div class="flex items-center gap-2 bg-slate-50 border pl-4 pr-2 py-2 rounded-full hover:border-emerald-200 transition-colors">
                                    <span onclick="window.editCat(${idx})" class="text-sm font-bold text-slate-600 cursor-pointer hover:text-emerald-600 transition-colors">
                                        ${c}
                                    </span>
                                    <div class="flex gap-1 border-l pl-2 border-slate-200">
                                        <button onclick="window.editCat(${idx})" class="text-slate-300 hover:text-blue-500 p-1.5 flex items-center justify-center transition-colors">
                                            <i data-lucide="edit-2" class="w-3.5 h-3.5"></i>
                                        </button>
                                        <button onclick="window.delCat(${idx})" class="text-slate-300 hover:text-rose-500 p-1.5 flex items-center justify-center transition-colors">
                                            <i data-lucide="x" class="w-3.5 h-3.5"></i>
                                        </button>
                                    </div>
                                </div>`).join('')}
                        </div>
                    </section>
                </div>`;
        }

        // --- MODAIS ---
        window.closeModal = () => { document.getElementById('modal-overlay').classList.remove('active'); };
        
        window.openTxModal = () => {
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="space-y-6">
                    <h3 class="text-2xl font-black text-slate-800">Nova Despesa</h3>
                    <div id="modal-error" class="hidden p-4 bg-rose-50 text-rose-600 text-[10px] font-black uppercase rounded-2xl"></div>
                    
                    <div class="space-y-4">
                        <div><label class="text-[9px] font-black text-slate-400 uppercase ml-2">O que é?</label><input type="text" id="tx-name" placeholder="Ex: Aluguel, Cartão, Luz..." class="w-full p-4 bg-slate-50 border rounded-2xl font-bold"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[9px] font-black text-slate-400 uppercase ml-2">Valor (R$)</label><input type="number" id="tx-amount" step="0.01" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold"></div>
                            <div><label class="text-[9px] font-black text-slate-400 uppercase ml-2">Categoria</label>
                                <select id="tx-cat" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold">
                                    ${state.categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[9px] font-black text-slate-400 uppercase ml-2">Parcelas</label><input type="number" id="tx-installments" min="1" value="1" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold"></div>
                            <div><label class="text-[9px] font-black text-slate-400 uppercase ml-2">Intervalo</label>
                                <select id="tx-freq" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold">
                                    <option value="monthly">Mensal</option>
                                    <option value="fortnightly">Quinzenal</option>
                                    <option value="weekly">Semanal</option>
                                    <option value="daily">Diária</option>
                                </select>
                            </div>
                        </div>
                        <div><label class="text-[9px] font-black text-slate-400 uppercase ml-2">Data Vencimento</label><input type="date" id="tx-date" value="${getISO(new Date())}" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold"></div>
                    </div>
                    <div class="flex gap-4 pt-4"><button onclick="window.closeModal()" class="flex-1 font-bold text-slate-400 uppercase text-[10px]">Cancelar</button><button onclick="window.confirmTx()" class="flex-1 py-4 bg-rose-600 text-white rounded-2xl font-black uppercase text-[10px]">Agendar Gasto</button></div>
                </div>`;
            document.getElementById('modal-overlay').classList.add('active');
        };

        window.confirmTx = () => {
            const name = document.getElementById('tx-name').value;
            const amount = parseFloat(document.getElementById('tx-amount').value);
            const instCount = parseInt(document.getElementById('tx-installments').value) || 1;
            const freq = document.getElementById('tx-freq').value;
            const startDate = document.getElementById('tx-date').value;
            const category = document.getElementById('tx-cat').value;

            if(!name || isNaN(amount)) return alert('Preencha nome e valor');

            let baseDate = new Date(startDate + 'T12:00:00');
            for(let i = 0; i < instCount; i++) {
                let currentTxDate = new Date(baseDate);
                if (freq === 'daily') currentTxDate.setDate(baseDate.getDate() + i);
                if (freq === 'weekly') currentTxDate.setDate(baseDate.getDate() + (i * 7));
                if (freq === 'fortnightly') currentTxDate.setDate(baseDate.getDate() + (i * 14));
                if (freq === 'monthly') currentTxDate.setMonth(baseDate.getMonth() + i);

                state.transactions.push({ 
                    id: generateUID(), 
                    name: instCount > 1 ? `${name} (${i + 1}/${instCount})` : name, 
                    amount, type: 'expense', category, 
                    date: getISO(currentTxDate), status: 'open' 
                });
            }
            window.save(); window.closeModal();
        };

        window.openPayModal = (id) => {
            const tx = state.transactions.find(t=>t.id===id);
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="space-y-6">
                    <h3 class="text-xl font-black text-slate-800">Confirmar Pagamento</h3>
                    <div class="bg-emerald-50 p-6 rounded-3xl border border-emerald-100 shadow-inner">
                        <p class="text-[10px] font-black text-emerald-600 uppercase mb-2">Resumo da Conta</p>
                        <h4 class="text-lg font-bold text-slate-700">${tx.name}</h4>
                        <p class="text-3xl font-black text-emerald-600">${fmtBRL(tx.amount)}</p>
                    </div>

                    <div class="bg-amber-50 p-5 rounded-3xl border border-amber-100 flex gap-4 items-start">
                        <div class="bg-amber-100 p-2 rounded-xl text-amber-600"><i data-lucide="alert-circle"></i></div>
                        <p class="text-xs font-bold text-amber-800 leading-relaxed">
                            <span class="block text-[10px] uppercase font-black text-amber-600 mb-1">Atenção!</span>
                            O saldo dos bancos cadastrados <span class="font-black underline">não será alterado</span> automaticamente. 
                            Lembre-se de atualizar o saldo real no menu <strong>Configurações/Bancos</strong> após pagar no seu banco.
                        </p>
                    </div>

                    <div class="flex flex-col gap-3">
                        <button onclick="window.confirmPay('${id}')" class="w-full py-5 bg-emerald-600 text-white rounded-2xl font-black uppercase text-xs shadow-xl shadow-emerald-100 transition-transform active:scale-95">
                            Confirmar Pagamento
                        </button>
                        <button onclick="window.closeModal()" class="w-full py-4 font-bold text-slate-400 uppercase text-[10px]">Cancelar</button>
                    </div>
                </div>`;
            document.getElementById('modal-overlay').classList.add('active');
            lucide.createIcons();
        };

        window.confirmPay = (tid) => {
            const t = state.transactions.find(x=>x.id===tid);
            if(t) {
                t.status = 'paid'; 
                window.save(); 
                window.closeModal(); 
            }
        };

        // --- AUXILIARES ---
        window.addBank = () => { state.banks.push({ id: 'b'+Date.now(), name: 'Novo Banco', balance: 0 }); window.save(); }
        window.updBank = (id, k, v) => { const b = state.banks.find(x=>x.id===id); if(b){ b[k] = k === 'balance' ? parseFloat(v)||0 : v; window.save(); } }
        window.delBank = (id) => { 
            if(confirm('Deseja excluir este banco?')) {
                state.banks = state.banks.filter(b => b.id !== id);
                window.save();
                if (state.banks.length === 0) window.render(); // Voltará para tela de setup se deletar tudo
            }
        }
        window.delTx = (id) => { if(confirm('Excluir?')){ state.transactions = state.transactions.filter(t=>t.id!==id); window.save(); } }

        window.openGoalModal = () => {
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="space-y-6">
                    <h3 class="text-2xl font-black text-slate-800">Nova Meta</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[9px] uppercase font-black ml-2 text-slate-400">Nome da Meta</label>
                            <input type="text" id="goal-name" placeholder="Ex: Viagem, Carro..." class="w-full p-4 bg-slate-50 border rounded-2xl font-bold">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[9px] uppercase font-black ml-2 text-slate-400">Saldo Inicial</label>
                                <input type="number" id="goal-cur" value="0" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold">
                            </div>
                            <div>
                                <label class="text-[9px] uppercase font-black ml-2 text-slate-400">Objetivo Final</label>
                                <input type="number" id="goal-tar" placeholder="Alvo (R$)" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold">
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-4 pt-4">
                        <button onclick="window.closeModal()" class="flex-1 font-bold text-slate-400 uppercase text-[10px]">Cancelar</button>
                        <button onclick="window.confirmGoal()" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black uppercase text-[10px]">Criar Meta</button>
                    </div>
                </div>`;
            document.getElementById('modal-overlay').classList.add('active');
        };

        window.confirmGoal = () => {
            const n = document.getElementById('goal-name').value;
            const tar = parseFloat(document.getElementById('goal-tar').value);
            const cur = parseFloat(document.getElementById('goal-cur').value) || 0;
            if(!n || isNaN(tar)) return alert('Preencha os campos obrigatórios');
            state.goals.push({ id: 'g'+Date.now(), name: n, target: tar, current: cur });
            window.save(); window.closeModal();
        };

        window.openSupplyPoolModal = () => {
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="space-y-6">
                    <h3 class="text-2xl font-black text-slate-800 text-center">Reserva em Mãos</h3>
                    <input type="number" id="pool-new" value="${state.savingsPool}" class="w-full p-6 bg-slate-50 border-2 rounded-3xl font-black text-3xl text-center text-emerald-600">
                    <div class="flex gap-4">
                        <button onclick="window.closeModal()" class="flex-1 font-bold text-slate-400 uppercase text-[10px]">Cancelar</button>
                        <button onclick="window.confirmPool()" class="flex-1 py-4 bg-emerald-600 text-white rounded-2xl font-black uppercase text-[10px]">Salvar</button>
                    </div>
                </div>`;
            document.getElementById('modal-overlay').classList.add('active');
        };

        window.confirmPool = () => {
            const val = parseFloat(document.getElementById('pool-new').value);
            state.savingsPool = isNaN(val) ? 0 : val;
            window.save(); window.closeModal();
        };

        window.onload = () => { window.load(); window.render(); };
    </script>
</body>
</html>
